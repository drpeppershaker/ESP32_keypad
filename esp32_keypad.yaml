esphome:
  name: esp32-keypad
  friendly_name: eps32_keypad

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:
#   level: INFO

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_key

ota:
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "esp32 Keypad Fallback Hotspot"
    password: !secret ssid_password

captive_portal:

#connections: all buttons are on VIN and on their respective pins
#(we are relying on esp32s built-in pulldown resistors but could have used external resistors as well)
#Button 1: GPIO25 / 
#Button 2: GPIO26 / 
#Button 3: GPIO27 / 
#Button 4: GPIO14 / 

#Button 5: GPIO19 / 
#Button 6: GPIO18 / 
#Button 7: GPI17 / 
#Button 8: GPIO16 


# Example configuration entry
light:
  # Example for light segment source
  - platform: fastled_clockless
    id: light1
    name: keypad
    chipset: WS2813
    pin: GPIO33
    num_leds: 8
    rgb_order: GRB
    default_transition_length: 0s
    restore_mode: RESTORE_AND_ON
    internal: True

  - platform: partition
    name: "Key 1"
    id: key1
    segments:
      - id: light1
        from: 0
        to: 0
    default_transition_length: 0s
    
  - platform: partition
    name: "Key 2"
    id: key2
    segments:
      - id: light1
        from: 1
        to: 1
    default_transition_length: 0s

  - platform: partition
    name: "Key 3"
    id: key3
    segments:
      - id: light1
        from: 2
        to: 2
    default_transition_length: 0s

  - platform: partition
    name: "Key 4"
    id: key4
    segments:
      - id: light1
        from: 3
        to: 3
    default_transition_length: 0s
      
  - platform: partition
    name: "Key 5"
    id: key5
    segments:
      - id: light1
        from: 4
        to: 4
    default_transition_length: 0s

  - platform: partition
    name: "Key 6"
    id: key6
    segments:
      - id: light1
        from: 5
        to: 5
    default_transition_length: 0s

  - platform: partition
    name: "Key 7"
    id: key7
    segments:
      - id: light1
        from: 6
        to: 6
    default_transition_length: 0s

  - platform: partition
    name: "Key 8"
    id: key8
    segments:
      - id: light1
        from: 7
        to: 7
    default_transition_length: 0s

  - platform: partition
    name: "Keypad"
    id: keypad
    default_transition_length: 0s
    segments:
      - id: light1
        from: 0
        to: 7
    effects:
      - pulse:
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
      - pulse:
          name: "Slow Pulse"
          # transition_length: 1s      # defaults to 1s
          update_interval: 2s
      - pulse:
          name: "Blink"
          transition_length: .25s      # defaults to 1s
          update_interval: .25s
      - addressable_rainbow:
      - addressable_rainbow:
          name: Rainbow Skinny
          speed: 10
          width: 25
      - addressable_scan:
      - addressable_scan:
          name: Scan Fast
          move_interval: 50ms
          scan_width: 1
      - addressable_twinkle:
      - addressable_random_twinkle:
      - addressable_fireworks:
          use_random_color: true
      - addressable_flicker:




# sensor:
#   - platform: homeassistant
#     id: key1_brightness
#     entity_id: light.eps32_keypad_key1
#     attribute: brightness
#   - platform: homeassistant
#     id: key2_brightness
#     entity_id: light.eps32_keypad_key2
#     attribute: brightness
#   - platform: homeassistant
#     id: key3_brightness
#     entity_id: light.eps32_keypad_key3
#     attribute: brightness
#   - platform: homeassistant
#     id: key4_brightness
#     entity_id: light.eps32_keypad_key4
#     attribute: brightness
#   - platform: homeassistant
#     id: key5_brightness
#     entity_id: light.eps32_keypad_key5
#     attribute: brightness
#   - platform: homeassistant
#     id: key6_brightness
#     entity_id: light.eps32_keypad_key6
#     attribute: brightness
#   - platform: homeassistant
#     id: key7_brightness
#     entity_id: light.eps32_keypad_key7
#     attribute: brightness
#   - platform: homeassistant
#     id: key8_brightness
#     entity_id: light.eps32_keypad_key8
#     attribute: brightness


# text_sensor:
#   - platform: homeassistant
#     id: keypad_effect
#     entity_id: light.eps32_keypad_keypad
#     attribute: rgb_color




binary_sensor:
  # Button 1
  - platform: gpio
    icon: "mdi:dialpad"
    name: "Keypad 2x4 Button 1"
    pin:
      number: GPIO25
      mode:
        input: true
        pulldown: true #was pulldown
    id: esp32_keypad_b1
    on_press:
      then:
        - light.turn_on:
            id: key1
            red: 1
            green: 1
            blue: 1
    on_release:
      then:
        - light.turn_off:
            id: key1

    on_multi_click:
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Double Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: dbl_click
              button: b1
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Triple Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: triple_click
              button: b1
    - timing:
      - ON for 1s to 2s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Long Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: long_click
              button: b1
    - timing:
      - ON for at least 2.2s
      then:
        - logger.log:
            format: "Click and Hold"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: hold
              button: b1
    - timing:
      - ON for at most 1s
      - OFF for at least 0.5s
      then:
        # - light.turn_off:
        #     id: light1
        - logger.log:
            format: "Single Short Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: single_click
              button: b1

  #Button 2
  - platform: gpio
    icon: "mdi:dialpad"
    name: "Keypad 2x4 Button 2"
    pin:
      number: GPIO26
      mode:
        input: true
        pulldown: true #was pulldown
    id: esp32_keypad_b2
    on_press:
      then:
        - light.turn_on:
            id: key2
            red: 1
            green: 1
            blue: 1
    on_release:
      then:
        - light.turn_off:
            id: key2
    on_multi_click:
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Double Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: dbl_click
              button: b2
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Triple Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: triple_click
              button: b2
    - timing:
      - ON for 1s to 2s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Long Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: long_click
              button: b2
    - timing:
      - ON for at least 2.2s
      then:
        - logger.log:
            format: "Click and Hold"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: hold
              button: b2
    - timing:
      - ON for at most 1s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Short Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: single_click
              button: b2
  #Button 3
  - platform: gpio
    icon: "mdi:dialpad"
    name: "Keypad 2x4 Button 3"
    pin:
      number: GPIO27
      mode:
        input: true
        pulldown: true #was pulldown
    id: esp32_keypad_b3
    on_press:
      then:
        - light.turn_on:
            id: key3
            red: 1
            green: 1
            blue: 1
    on_release:
      then:
        - light.turn_off:
            id: key3
    on_multi_click:
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Double Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: dbl_click
              button: b3
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Triple Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: triple_click
              button: b3
    - timing:
      - ON for 1s to 2s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Long Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: long_click
              button: b3
    - timing:
      - ON for at least 2.2s
      then:
        - logger.log:
            format: "Click and Hold"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: hold
              button: b3
    - timing:
      - ON for at most 1s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Short Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: single_click
              button: b3
  #Button 4
  - platform: gpio
    icon: "mdi:dialpad"
    name: "Keypad 2x4 Button 4"
    pin:
      number: GPIO14
      mode:
        input: true
        pulldown: true #was pulldown
    id: esp32_keypad_b4
    on_press:
      then:
        - light.turn_on:
            id: key4
            red: 1
            green: 1
            blue: 1
    on_release:
      then:
        - light.turn_off:
            id: key4
    on_multi_click:
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Double Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: dbl_click
              button: b4
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Triple Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: triple_click
              button: b4
    - timing:
      - ON for 1s to 2s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Long Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: long_click
              button: b4
    - timing:
      - ON for at least 2.2s
      then:
        - logger.log:
            format: "Click and Hold"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: hold
              button: b4
    - timing:
      - ON for at most 1s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Short Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: single_click
              button: b4
    #Button 5
  - platform: gpio
    icon: "mdi:dialpad"
    name: "Keypad 2x4 Button 5"
    pin:
      number: GPIO19
      mode:
        input: true
        pulldown: true #was pulldown
    id: esp32_keypad_b5
    on_press:
     then:
        - light.turn_on:
            id: key5
            red: 1
            green: 1
            blue: 1
    on_release:
      then:
        - light.turn_off:
            id: key5
    on_multi_click:
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Double Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: dbl_click
              button: b5
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Triple Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: triple_click
              button: b5
    - timing:
      - ON for 1s to 2s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Long Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: long_click
              button: b5
    - timing:
      - ON for at least 2.2s
      then:
        - logger.log:
            format: "Click and Hold"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: hold
              button: b5
    - timing:
      - ON for at most 1s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Short Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: single_click
              button: b5
    #Button 6
  - platform: gpio
    icon: "mdi:dialpad"
    name: "Keypad 2x4 Button 6"
    pin:
      number: GPIO18
      mode:
        input: true
        pulldown: true
    id: esp32_keypad_b6
    on_press:
     then:
        - light.turn_on:
            id: key6
            red: 1
            green: 1
            blue: 1
    on_release:
      then:
        - light.turn_off:
            id: key6
    on_multi_click:
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Double Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: dbl_click
              button: b6
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Triple Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: triple_click
              button: b6
    - timing:
      - ON for 1s to 2s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Long Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: long_click
              button: b6
    - timing:
      - ON for at least 2.2s
      then:
        - logger.log:
            format: "Click and Hold"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: hold
              button: b6
    - timing:
      - ON for at most 1s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Short Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: single_click
              button: b6
    #Button 7
  - platform: gpio
    icon: "mdi:dialpad"
    name: "Keypad 2x4 Button 7"
    pin:
      number: GPIO17
      mode:
        input: true
        pulldown: true #was pulldown
    id: esp32_keypad_b7
    on_press:
     then:
        - light.turn_on:
            id: key7
            red: 1
            green: 1
            blue: 1
    on_release:
      then:
        - light.turn_off:
            id: key7
    on_multi_click:
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Double Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: dbl_click
              button: b7
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Triple Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: triple_click
              button: b7
    - timing:
      - ON for 1s to 2s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Long Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: long_click
              button: b7
    - timing:
      - ON for at least 2.2s
      then:
        - logger.log:
            format: "Click and Hold"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: hold
              button: b7
    - timing:
      - ON for at most 1s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Short Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: single_click
              button: b7
    #Button 8
  - platform: gpio
    icon: "mdi:dialpad"
    name: "Keypad 2x4 Button 8"
    pin:
      number: GPIO16
      mode:
        input: true
        pulldown: true
    id: esp32_keypad_b8
    on_press:
      then:
        - light.turn_on:
            id: key8
            red: 1
            green: 1
            blue: 1
    on_release:
      then:
        - light.turn_off:
            id: key8
    on_multi_click:
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Double Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: dbl_click
              button: b8
    - timing:
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at most 1s
      - ON for at most 1s
      - OFF for at least 0.2s
      then:
        - logger.log:
            format: "Triple Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: triple_click
              button: b8
    - timing:
      - ON for 1s to 2s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Long Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: long_click
              button: b8
    - timing:
      - ON for at least 2.2s
      then:
        - logger.log:
            format: "Click and Hold"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: hold
              button: b8
    - timing:
      - ON for at most 1s
      - OFF for at least 0.5s
      then:
        - logger.log:
            format: "Single Short Clicked"
            level: INFO
        - homeassistant.event:
            event: esphome.esp32_keypad
            data:
              title: single_click
              button: b8
